name: Backend CI/CD Pipeline

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  IMAGE_PREFIX: saferoute

jobs:
  backend-ci:
    name: Run Lint & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f "requirements_dev.txt" ]; then
            pip install -r requirements_dev.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No requirements file found" && exit 1
          fi

      - name: Run linting tools (in correct order)
        run: |
          set -e
          echo "Running ruff (linting and import sorting)..."
          ruff check . --fix || true
          ruff format . || true
          
          echo "Running isort (import sorting)..."
          isort . || true
          
          echo "Running black (code formatting)..."
          black . || true
          
          echo "Linting complete"

      - name: Run pre-commit hooks
        run: |
          set -e
          pre-commit run --all-files || true

      - name: Run pytest (unit tests)
        run: |
          set -e
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            pytest --tb=short
          else
            echo "No pytest configuration found, skipping tests"
          fi

  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: backend-ci
    # Only build on push to main branch, not on PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: detect
        run: |
          set -e
          echo "Detecting which services changed..."
          
          # Get the base commit (previous commit on main branch)
          # If this is the first commit, use empty tree
          BASE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          if [ -z "$BASE_SHA" ]; then
            echo "No previous commit found, comparing with empty tree"
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR 4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD || git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR $BASE_SHA HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          ALL_SERVICES="feedback notification routing_service safety_scoring sos user_management"
          CHANGED_SERVICES=""
          
          # Check if shared files changed (requires rebuilding all services)
          if echo "$CHANGED_FILES" | grep -Eq "requirements|libs/|.github/workflows/"; then
            echo "Shared files changed, will build all services"
            CHANGED_SERVICES="$ALL_SERVICES"
          else
            # Check which specific services changed
            for SERVICE in $ALL_SERVICES; do
              if echo "$CHANGED_FILES" | grep -q "services/$SERVICE/"; then
                CHANGED_SERVICES="$CHANGED_SERVICES $SERVICE"
                echo "Service changed: $SERVICE"
              fi
            done
          fi
          
          CHANGED_SERVICES=$(echo "$CHANGED_SERVICES" | xargs)
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No services changed, skipping build"
          else
            echo "Services to build: $CHANGED_SERVICES"
          fi
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push changed images
        if: steps.detect.outputs.services != ''
        run: |
          set -e
          for SERVICE in ${{ steps.detect.outputs.services }}; do
            echo "Building and pushing $SERVICE..."
            # Build with version tag (git SHA) and latest tag
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            docker buildx build \
              --platform linux/amd64 \
              -f ./services/$SERVICE/dockerfile \
              -t ${{ env.IMAGE_PREFIX }}/$SERVICE:${{ github.sha }} \
              -t ${{ env.IMAGE_PREFIX }}/$SERVICE:$SHORT_SHA \
              -t ${{ env.IMAGE_PREFIX }}/$SERVICE:latest \
              --push \
              --cache-from type=registry,ref=${{ env.IMAGE_PREFIX }}/$SERVICE:buildcache \
              --cache-to type=registry,ref=${{ env.IMAGE_PREFIX }}/$SERVICE:buildcache,mode=max \
              .
            echo "Successfully built and pushed $SERVICE:${{ github.sha }}"
          done

      - name: Skip build if no services changed
        if: steps.detect.outputs.services == ''
        run: echo "No services changed. Skipping Docker build."

      - name: Trigger deployment (optional)
        if: steps.detect.outputs.services != '' && github.ref == 'refs/heads/main'
        uses: peter-evans/repository-dispatch@v2
        continue-on-error: true
        with:
          token: ${{ secrets.MANIFEST_REPO_TOKEN }}
          repository: SafeRoute-Trinity/manifests
          event-type: deploy-service
          client-payload: |
            {
              "service": "${{ steps.detect.outputs.services }}",
              "image_tag": "${{ github.sha }}",
              "environment": "production"
            }
